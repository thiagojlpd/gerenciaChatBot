<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot de Detona√ß√£o</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Definindo cores e fontes do Material Design */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #333;
            flex-direction: column;
            /* Permite o layout flex√≠vel vertical */
        }

        h2 {
            font-size: 24px;
            color: #00796b;
            margin-bottom: 20px;
        }

        /* Container do chat */
        #chatbox {
            width: 800px;
            height: 400px;
            border-radius: 8px;
            border: 1px solid #ccc;
            background-color: #fff;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.3s ease;
        }

        /* Estilo do bot√£o */
        button {
            background-image: linear-gradient(to right, #00796b, #00796b);
            /* Gradiente linear */
            color: white;
            font-size: 16px;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-image 0.3s;
            /* Transi√ß√£o suave para o gradiente */
            margin-top: 10px;
        }

        /* Efeito de mudan√ßa de cor do gradiente ao passar o mouse */
        button:hover {
            background-image: linear-gradient(to right, #00796b, #00796b);
            /* Inverte as cores no hover */
        }


        /* Input de texto */
        #userInput {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 10px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        #userInput:focus {
            border-color: #00796b;
            outline: none;
        }

        /* Adicionando anima√ß√£o fade-in */
        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        /* Anima√ß√£o de fade-in */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }


        /* Estilo das mensagens */
        .user-message,
        .bot-message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            max-width: 95%;
            word-wrap: break-word;
        }

        .user-message {
            background-color: #00796b;
            color: white;
            align-self: flex-end;
            animation: slideInRight 0.5s ease;
        }

        .bot-message {
            background-color: #eeeeee;
            color: #333;
            animation: slideInLeft 0.5s ease;
        }

        /* Anima√ß√£o de entrada das mensagens */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
            }

            to {
                transform: translateX(0);
            }
        }

        .follow-up {
            font-style: italic;
            color: #00796b;
            margin-top: 10px;
        }
    </style>
</head>

<body>

    <div>
        <h2>Chatbot sobre necessidades de detona√ß√£o</h2>
        <div id="chatbox"></div>
        <input type="text" id="userInput" placeholder="Digite sua pergunta...">
        <button onclick="sendMessage()">Enviar</button>
    </div>

    <script>
        const rules = {
            "Respons√°vel T√©cnico": {
                "Quem pode ser o respons√°vel t√©cnico pela detona√ß√£o?": "S√£o aceitos como respons√°vel t√©cnico: engenheiro de minas, engenheiro civil, ge√≥logo, t√©cnico em minera√ß√£o, que devem possuir registro no CREA /CRT.",
                "O respons√°vel t√©cnico pela detona√ß√£o deve ter v√≠nculo com a contratante ou contratada?": "O respons√°vel t√©cnico designado na autoriza√ß√£o de detona√ß√£o deve ter v√≠nculo com a empresa respons√°vel pela detona√ß√£o.",
                "Quem deve assinar a ART ou CRT?": "O respons√°vel pela ART/CRT deve ser o mesmo respons√°vel pelo servi√ßo de detona√ß√£o descrito no requerimento da autoriza√ß√£o do servi√ßo de detona√ß√£o.",
                "A ART pode ser assinada por profissional de outras regi√µes do pa√≠s (CREA MG, RJ etc.)?": "Sim, desde que ele tenha v√≠nculo com a empresa executante do servi√ßo de detona√ß√£o."
            },
            "Autoriza√ß√£o de Detona√ß√£o": {
                "Quem presta o servi√ßo de detona√ß√£o para terceiros (contratado) precisa possuir registro? E com qual atividade no registro?": "O prestador do servi√ßo de detona√ß√£o (contratado) deve possuir registro, especificamente com a atividade de 'presta√ß√£o de servi√ßo de detona√ß√£o'.",
                "Quem contrata o servi√ßo de detona√ß√£o precisa possuir registro? E com qual atividade no registro?": "Quem contrata o servi√ßo (contratante) precisa ter registro com a atividade 'utiliza√ß√£o - aplica√ß√£o de explosivos' (somente de forma terceirizada)."
            },
            "Autoriza√ß√£o para Aquisi√ß√£o de Explosivos": {
                "Quando deve ser requerida a 'autoriza√ß√£o para aquisi√ß√£o de explosivos'?": "A 'autoriza√ß√£o para aquisi√ß√£o de explosivos' deve ser solicitada, e se faz necess√°ria sempre que houver a aquisi√ß√£o dos explosivos classificados nos grupos de ordem 3.1, 3.3 e 3.4.",
                "O que √© necess√°rio para requerer a 'autoriza√ß√£o para aquisi√ß√£o de explosivos'?": "Para a aquisi√ß√£o de explosivos, √© necess√°rio registro com atividade que pressuponha a aquisi√ß√£o e com a atividade de armazenamento apostilada."
            },
            "Teoria dos Quart√™nios": {
                "O que √© a teoria dos quart√™nios?": "A teoria dos quart√™nios √© um conceito matem√°tico que envolve a utiliza√ß√£o de n√∫meros chamados 'quart√™nios'. Esses n√∫meros formam uma extens√£o dos n√∫meros reais e complexos e s√£o usados para representar rota√ß√µes no espa√ßo tridimensional.",
                "Quem foi o respons√°vel pela cria√ß√£o dos quart√™nios?": "Os quart√™nios foram introduzidos por William Rowan Hamilton, um matem√°tico irland√™s, em 1843. Ele buscava uma forma de representar rota√ß√µes tridimensionais e acabou desenvolvendo os quart√™nios.",
                "Como os quart√™nios se relacionam com os n√∫meros complexos?": "Os quart√™nios podem ser vistos como uma extens√£o dos n√∫meros complexos. Enquanto os n√∫meros complexos consistem de uma parte real e uma parte imagin√°ria, os quart√™nios t√™m uma parte real e tr√™s componentes imagin√°rios.",
                "Qual √© a forma geral de um quart√™nio?": "Um quart√™nio √© geralmente representado como q = a + bi + cj + dk, onde a, b, c, e d s√£o n√∫meros reais e i, j, k s√£o as unidades imagin√°rias, com propriedades espec√≠ficas de multiplica√ß√£o.",
                "Quais s√£o as propriedades das unidades imagin√°rias i, j, e k?": "As unidades imagin√°rias i, j, e k t√™m as seguintes propriedades: i¬≤ = j¬≤ = k¬≤ = ijk = -1, ij = k, jk = i, ki = j. As multiplica√ß√µes entre elas n√£o comutam, ou seja, a multiplica√ß√£o de quart√™nios √© n√£o comutativa.",
                "Como os quart√™nios s√£o utilizados para representar rota√ß√µes tridimensionais?": "Os quart√™nios s√£o usados para representar rota√ß√µes no espa√ßo tridimensional de maneira eficiente, sem as limita√ß√µes das matrizes de rota√ß√£o, como a singularidade ou a complexidade computacional.",
                "O que √© a multiplica√ß√£o de quart√™nios?": "A multiplica√ß√£o de quart√™nios √© uma opera√ß√£o bin√°ria que segue regras espec√≠ficas, como a n√£o comutatividade. A multiplica√ß√£o de quart√™nios pode ser vista como a composi√ß√£o de rota√ß√µes no espa√ßo tridimensional.",
                "Qual √© a diferen√ßa entre n√∫meros complexos e quart√™nios em termos de dimensionalidade?": "Os n√∫meros complexos s√£o bidimensionais, compostos de uma parte real e uma imagin√°ria, enquanto os quart√™nios s√£o uma estrutura de 4 dimens√µes (1 real e 3 imagin√°rias).",
                "Os quart√™nios t√™m alguma aplica√ß√£o pr√°tica?": "Sim, os quart√™nios s√£o amplamente usados em gr√°ficos computacionais, computa√ß√£o 3D, f√≠sica qu√¢ntica, rob√≥tica e na modelagem de rota√ß√µes em sistemas tridimensionais.",
                "Como a teoria dos quart√™nios √© √∫til em computa√ß√£o gr√°fica?": "Na computa√ß√£o gr√°fica, os quart√™nios s√£o usados para representar e realizar rota√ß√µes em objetos 3D de forma mais eficiente que as matrizes de rota√ß√£o tradicionais, evitando problemas como gimbal lock.",
                "O que √© o 'gimbal lock' e como os quart√™nios ajudam a evitar isso?": "O gimbal lock √© uma situa√ß√£o onde, em uma rota√ß√£o de 3D, duas das tr√™s rotas de rota√ß√£o se alinham, causando a perda de um grau de liberdade. Os quart√™nios evitam esse problema, permitindo uma representa√ß√£o mais est√°vel das rota√ß√µes.",
                "Quais s√£o as vantagens de usar quart√™nios em vez de matrizes de rota√ß√£o?": "Os quart√™nios s√£o mais eficientes computacionalmente, exigem menos opera√ß√µes (quatro multiplica√ß√µes em vez de nove), e n√£o sofrem com o gimbal lock. Eles tamb√©m s√£o mais est√°veis e precisos em simula√ß√µes de rota√ß√£o cont√≠nua.",
                "Os quart√™nios podem ser invertidos?": "Sim, os quart√™nios t√™m uma opera√ß√£o de invers√£o. Para um quart√™nio q = a + bi + cj + dk, o inverso √© dado por q‚Åª¬π = (a - bi - cj - dk) / (a¬≤ + b¬≤ + c¬≤ + d¬≤), onde o denominador √© o m√≥dulo ao quadrado do quart√™nio.",
                "Qual √© o papel da parte real em um quart√™nio?": "A parte real a de um quart√™nio √© respons√°vel pela componente escalar, enquanto as partes imagin√°rias b, c, e d s√£o respons√°veis pela componente vetorial. A parte real determina a magnitude da rota√ß√£o.",
                "Existe alguma rela√ß√£o entre os quart√™nios e a √°lgebra de Lie?": "Sim, os quart√™nios podem ser vistos como uma √°lgebra de Lie, que √© uma estrutura matem√°tica usada para estudar simetrias e transforma√ß√µes. No caso dos quart√™nios, eles formam uma √°lgebra n√£o comutativa, o que √© uma caracter√≠stica t√≠pica de certas √°lgebra de Lie."
            }
        };

        bestMatchTwoZeroResponse = 0;
        let showingTopics = false;

        function listTopics() {
            let message = "<strong>Lista de t√≥picos dispon√≠veis:</strong><br>";
            let index = 1;
            for (const category in rules) {
                message += `${index}. ${category}<br>`;
                index++;
            }
            message += `<div class="follow-up">Digite o n√∫mero do t√≥pico desejado para ver as perguntas e respostas correspondentes.</div>`;
            showingTopics = true;
            return message;
        }

        function showQuestionsByTopic(index) {
            const categories = Object.keys(rules);
            const topicIndex = parseInt(index, 10) - 1;

            if (isNaN(topicIndex) || topicIndex < 0 || topicIndex >= categories.length) {
                return "N√∫mero inv√°lido. Por favor, escolha um dos n√∫meros listados.";
            }

            const selectedCategory = categories[topicIndex];
            const questions = rules[selectedCategory];
            let message = `<strong>${selectedCategory}:</strong><br>`;
            for (const question in questions) {
                message += `<br><strong>Q:</strong> ${question}<br><strong>R:</strong> ${questions[question]}<br>`;
            }
            showingTopics = false;
            bestMatchTwoZeroResponse = 0;
            return message;
        }

        /**
     * Calcula a dist√¢ncia de Levenshtein entre duas palavras.
     * Essa m√©trica mede o n√∫mero m√≠nimo de opera√ß√µes (inser√ß√µes, dele√ß√µes e substitui√ß√µes)
     * necess√°rias para transformar uma string na outra.
     */
        function levenshteinDistance(a, b) {
            const matrix = Array.from({ length: a.length + 1 }, (_, i) => Array(b.length + 1).fill(0));

            // Inicializa as primeiras colunas e linhas da matriz
            for (let i = 0; i <= a.length; i++) matrix[i][0] = i;
            for (let j = 0; j <= b.length; j++) matrix[0][j] = j;

            // Preenche a matriz comparando os caracteres das palavras
            for (let i = 1; i <= a.length; i++) {
                for (let j = 1; j <= b.length; j++) {
                    const cost = a[i - 1] === b[j - 1] ? 0 : 1; // Se os caracteres forem iguais, custo = 0; sen√£o, custo = 1
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j] + 1,       // Remo√ß√£o
                        matrix[i][j - 1] + 1,       // Inser√ß√£o
                        matrix[i - 1][j - 1] + cost // Substitui√ß√£o
                    );
                }
            }
            return matrix[a.length][b.length]; // Retorna a dist√¢ncia calculada
        }

        /**
         * Extrai palavras-chave de uma string removendo espa√ßos e convertendo para min√∫sculas.
         * Apenas palavras com mais de 2 caracteres s√£o consideradas.
         */
        function extractKeywords(text) {
            return text.toLowerCase().split(" ").filter(word => word.length > 2);
        }

        /**
         * Encontra a melhor correspond√™ncia para a pergunta do usu√°rio.
         * Utiliza a dist√¢ncia de Levenshtein para permitir pequenos erros de digita√ß√£o.
         */
        function findBestMatch(userText) {
            const userKeywords = extractKeywords(userText);
            let bestMatch = { question: "", answer: "", score: 0 };

            // Percorre todas as categorias de perguntas
            for (const category in rules) {
                for (const question in rules[category]) {
                    const questionKeywords = extractKeywords(question);
                    let score = 0;

                    // Compara cada palavra-chave digitada pelo usu√°rio com as palavras da pergunta cadastrada
                    userKeywords.forEach(userWord => {
                        questionKeywords.forEach(questionWord => {
                            const distance = levenshteinDistance(userWord, questionWord);

                            // Se a palavra for id√™ntica ou tiver at√© 2 diferen√ßas (para palavras com mais de 3 letras), conta como um match
                            if (distance === 0 || (distance <= 2 && questionWord.length > 3)) {
                                score++;
                            }
                        });
                    });

                    // Atualiza o melhor match encontrado, caso tenha uma pontua√ß√£o maior
                    if (score > bestMatch.score) {
                        bestMatch = { question: question, answer: rules[category][question], score: score };
                    }
                }
            }

            return bestMatch;
        }


        /**
             * Envia a mensagem quando o usu√°rio pressiona "Enter".
             */
        function handleKeyPress(event) {
            if (event.key === "Enter") {
                sendMessage(); // Chama a fun√ß√£o que envia a mensagem
            }
        }

        // Adiciona o ouvinte de evento para a tecla Enter
        document.getElementById("userInput").addEventListener("keypress", handleKeyPress);

        /**
             * Fun√ß√£o para obter uma sauda√ß√£o com base no hor√°rio do dia.
             * Exemplo: "Bom dia", "Boa tarde" ou "Boa noite".
             */
        function getGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) {
                return "Bom dia";
            } else if (hour < 18) {
                return "Boa tarde";
            } else {
                return "Boa noite";
            }
        }


        /**
             * Fun√ß√£o que retorna uma mensagem de boas-vindas aleat√≥ria.
             * Existem v√°rias op√ß√µes de mensagens para dar a impress√£o de intera√ß√µes diferentes.
             */
        function getRandomWelcomeMessage() {
            const welcomeMessages = [
                "Como posso te ajudar hoje?",
                "Tudo bem? Como posso ser √∫til para voc√™?",
                "Seja bem-vindo! O que posso fazer por voc√™?",
                "Como posso te ajudar neste dia?",
                "Em que posso te ajudar hoje?",
                "Como posso te ajudar? Estou aqui para isso!",
                "O que posso fazer por voc√™?",
                "Bem-vindo ao nosso chat! Como posso te auxiliar?",
                "Como posso ajudar voc√™ com suas d√∫vidas?",
                "Em que posso ser √∫til para voc√™ hoje?"
            ];

            // Retorna uma mensagem aleat√≥ria da lista
            return welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
        }


        /**
             * Fun√ß√£o que exibe a sauda√ß√£o de boas-vindas assim que a p√°gina √© carregada.
             * Inclui uma sauda√ß√£o com base no hor√°rio do dia.
             */
        function displayWelcomeMessage() {
            const chatbox = document.getElementById("chatbox");
            const greeting = getGreeting();  // Obt√©m a sauda√ß√£o com base no hor√°rio do dia
            const randomMessage = getRandomWelcomeMessage();  // Obt√©m uma mensagem de boas-vindas aleat√≥ria
            const welcomeMessage = `${greeting}! ${randomMessage}`;

            // Adiciona a mensagem de boas-vindas ao chat
            chatbox.innerHTML += `<div class="bot-message">ü§ñ <strong>Bot:</strong> ${welcomeMessage}</div>`;
            chatbox.scrollTop = chatbox.scrollHeight;  // Garante que a √∫ltima mensagem fique vis√≠vel

            document.getElementById("userInput").focus();
        }

        // Exibe a mensagem de boas-vindas quando a p√°gina for carregada
        window.onload = displayWelcomeMessage;

        function escapeHTML(str) {
            return str.replace(/[&<>"'\/]/g, function (char) {
                switch (char) {
                    case '&': return '&amp;';
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '"': return '&quot;';
                    case "'": return '&#039;';
                    case '/': return '&#x2F;';
                    default: return char;
                }
            });
        }        

        function sanitizeInput(input) {
            // Cria um elemento div tempor√°rio para remover qualquer tag HTML
            const div = document.createElement('div');
            div.textContent = input;  // Usa textContent para garantir que o conte√∫do seja tratado como texto puro
            return div.innerHTML;     // Retorna o texto sanitizado
        }

        function sendMessage() {
            const inputField = document.getElementById("userInput");
            const chatbox = document.getElementById("chatbox");
            let userText = inputField.value.trim();

            if (!userText) return;

            // Sanitiza a entrada do usu√°rio
            userText = sanitizeInput(userText);

            // Exibe mensagem do usu√°rio de forma segura (sem innerHTML)
            var numeroAleatorioUserMessage = Math.floor(Math.random() * 10000);
            const userMessageDiv = document.createElement('div');
            userMessageDiv.id = numeroAleatorioUserMessage;
            userMessageDiv.classList.add('user-message');
            userMessageDiv.innerHTML = `üßë‚Äçüè´ <strong>Voc√™:</strong> ${userText}`;
            chatbox.appendChild(userMessageDiv);

            let botResponse = "";
            let followUpText = "";

            if (showingTopics && /^\d+$/.test(userText)) {
                // Usu√°rio escolheu um n√∫mero de t√≥pico
                botResponse = showQuestionsByTopic(userText);
            } else {
                const bestMatch = findBestMatch(userText);
                if (bestMatch.score > 0) {
                    botResponse = bestMatch.answer;
                    followUpText = `Caso esteja se referindo √† pergunta: <em>"${bestMatch.question}"</em>.`;
                    bestMatchTwoZeroResponse = 0;
                } else {
                    bestMatchTwoZeroResponse++;
                    botResponse = "Desculpe, n√£o tenho uma resposta para essa pergunta. Por favor, pergunte-me sobre assuntos relacionados ou, se preferir, envie-nos uma mensagem atrav√©s de nosso e-mail üí° 'Fale Conosco'.";
                    if (bestMatchTwoZeroResponse >= 2) {
                        botResponse += "<br><br>" + listTopics();
                    }
                }
            }

            var numeroAleatorioBotMessage = Math.floor(Math.random() * 10000);
            const botMessageDiv = document.createElement('div');
            botMessageDiv.id = numeroAleatorioBotMessage;
            botMessageDiv.classList.add('bot-message');
            botMessageDiv.innerHTML = `ü§ñ <strong>Bot:</strong> ${followUpText} ${botResponse} <br> `;
            chatbox.appendChild(botMessageDiv);

            chatbox.scrollTop = chatbox.scrollHeight;
            inputField.value = "";

            // Remove a anima√ß√£o ap√≥s 0.5s (dura√ß√£o da anima√ß√£o)
            setTimeout(() => {
                var lastUserMessageDiv = document.getElementById(`${numeroAleatorioUserMessage}`);
                var lastBotMessageDiv = document.getElementById(`${numeroAleatorioBotMessage}`);
                lastUserMessageDiv.classList.remove("fade-in");
                lastBotMessageDiv.classList.remove("fade-in");
            }, 1000);
        }

    </script>
</body>

</html>